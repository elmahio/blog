<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,100,700" media="all">
        
        
        
        <link rel="shortcut icon" href="../favicon.ico">
        

	<title>Running ElasticSearch in a cluster on Azure - elmah.io Blog</title>

        <link href="../css/bootstrap-3.0.3.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">
        <link href="../style.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
        <script src="/js/search.js"></script>
        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-42575460-2', 'blog.elmah.io');
            ga('send', 'pageview');
        </script>
        
        <script src="../js/jquery-1.10.2.min.js"></script>
    </head>

    <body>
		
        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="https://elmah.io/">elmah.io</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
                <li><a href="https://elmah.io/features/" id="NavFeatures">Features</a></li>
                <li><a href="https://elmah.io/about/" id="NavAbout">About</a></li>
                <li><a href="https://elmah.io/pricing/" id="NavPricing">Pricing</a></li>
                <li><a href="http://docs.elmah.io" id="NavDocs">Docs</a></li>
                <li><a href="http://blog.elmah.io/" id="NavBlog">Blog</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                    <li class="visible-xs">
                        <a href="/authentication/redirect/Twitter" class="pull-left"><span class="fa fa-twitter icon-2x"></span></a>
                        <a href="/authentication/redirect/Facebook" class="pull-left"><span class="fa fa-facebook icon-2x"></span></a>
                        <a href="/authentication/redirect/Google" class="pull-left"><span class="fa fa-google-plus icon-2x"></span></a>
                        <a href="/authentication/redirect/windowslive" class="pull-left"><span class="fa fa-windows icon-2x"></span></a>
                    </li>
                    <li class="hidden-xs"><span class="navbar-text text-muted">Sign in:</span></li>
                    <li class="hidden-xs"><a href="https://elmah.io//authentication/redirect/Twitter"><span class="fa fa-twitter"></span></a></li>
                    <li class="hidden-xs"><a href="https://elmah.io//authentication/redirect/Facebook"><span class="fa fa-facebook"></span></a></li>
                    <li class="hidden-xs"><a href="https://elmah.io//authentication/redirect/Google"><span class="fa fa-google-plus"></span></a></li>
                    <li class="hidden-xs"><a href="https://elmah.io//authentication/redirect/windowslive"><span class="fa fa-windows"></span></a></li>
                </ul>
        </div>
    </div>
</div>

        <div class="container">
            
		
            <div class="col-md-3"><div class="bs-sidebar hidden-print" role="complementary">
	
    <div class="icon-in-input">
        <input type="text" class="form-control" id="search" onclick="initSearchFunctionality()"/>
        <button type="button" class="fa fa-search"></button>
    </div>
    <h4 id="searchResultHeader">Search result</h4>
    <div id="searchResult">
    <ul class="nav bs-sidenav">
    </ul>
        <hr/>
    </div>
	
		
			<h2>Posts</h2>
    
		
			<h4 href="#" >2015 December</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../elmah-io-technology-stack/">elmah.io Technology Stack</a>
				</li>
			
				<li >
					<a href="../yearly-subscriptions/">Yearly Subscriptions</a>
				</li>
			
				<li >
					<a href="../asp-net-error-logging-best-practices/">ASP.NET Error Logging Best Practices</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2015 September</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../danish-service-provides-maximum-scaling-and-secures-data-on-azure/">Danish service provides maximum scaling and secures data on Azure</a>
				</li>
			
				<li >
					<a href="../elmah-io-documentation/">elmah.io documentation</a>
				</li>
			
				<li >
					<a href="../Building-a-salable-architecture-to-handle-millions-of-errors/">Building a salable architecture to handle millions of errors</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2015 August</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../sending-transactional-emails-using-mandrill-and-net/">Sending transactional emails using Mandrill and .NET</a>
				</li>
			
				<li >
					<a href="../logging-to-elmah-io-from-nlog/">Logging to elmah.io from NLog</a>
				</li>
			
				<li >
					<a href="../umbraco-and-elmah-io-are-new-best-friends/">Umbraco and elmah.io are new best friends</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2015 July</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../receive-an-email-when-a-new-error-is-logged/">Receive an email when a new error is logged</a>
				</li>
			
				<li >
					<a href="../its-official-elmah-io-integrates-with-zapier/">It’s official – elmah.io integrates with Zapier</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2015 June</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../new-mail-template/">New mail template</a>
				</li>
			
				<li >
					<a href="../integrate-elmah-io-with-slack/">Integrate elmah.io with Slack</a>
				</li>
			
				<li >
					<a href="../integrate-elmah-io-with-hipchat/">Integrate elmah.io with HipChat</a>
				</li>
			
				<li >
					<a href="../how-to-use-extended-user-details-even-though-you-dont-use-email-as-user-id/">How to use Extended User Details even though you don’t use email as user ID</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2015 May</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../get-better-insights-with-the-error-occurence-graph/">Get better insights with the error occurence graph</a>
				</li>
			
				<li >
					<a href="../removing-sensitive-form-data-before-logging-to-elmah/">Removing sensitive form data before logging to ELMAH</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2015 April</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../logging-to-multiple-elmah-logs/">Logging to multiple ELMAH logs</a>
				</li>
			
				<li >
					<a href="../daily-digest-email/">Daily Digest Email</a>
				</li>
			
				<li >
					<a href="../invoicing/">Invoicing</a>
				</li>
			
				<li >
					<a href="../api-v2-released/">API v2 Released</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2015 March</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../extended-user-details/">Extended User Details</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2015 February</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../logging-custom-data-to-elmah-io/">Logging custom data to elmah.io</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2015 January</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../trial-accounts-introduced/">Trial accounts introduced</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 December</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../api-v2-beta-released/">API v2 Beta Released</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 November</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../elmah-code-snippets-for-visual-studio/">ELMAH Code Snippets for Visual Studio</a>
				</li>
			
				<li >
					<a href="../elmah-io-have-been-accepted-onto-microsoft-bizspark/">elmah.io have been accepted onto Microsoft BizSpark</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 October</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../how-to-log-errors-to-elmah-programmatically/">How to log errors to ELMAH programmatically</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 September</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../elmah-vs-log4net/">ELMAH vs log4net</a>
				</li>
			
				<li >
					<a href="../logging-to-elmah-io-through-a-http-proxy/">Logging to elmah.io through a HTTP proxy</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 August</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../logging-to-elmah-io-from-javascript-using-jsnlog/">Logging to elmah.io from JavaScript using JSNLog</a>
				</li>
			
				<li >
					<a href="../great-new-features-for-our-paying-customers/">Great new features for our paying customers</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 July</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../say-hello-to-the-redesigned-overview/">Say hello to the redesigned Overview</a>
				</li>
			
				<li >
					<a href="../introducing-the-new-visual-studio-extension/">Introducing the new Visual Studio extension</a>
				</li>
			
				<li >
					<a href="../unlimited-logs-now-available-on-all-paid-plans/">Unlimited logs now available on all paid plans</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 June</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../introducing-the-small-business-plan/">Introducing the Small Business plan</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 May</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../new-feature-burst-protection/">New Feature Burst Protection</a>
				</li>
			
				<li >
					<a href="../new-release-cycle/">New release cycle</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 April</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../logging-to-elmah-io-from-log4net/">Logging from Log4net</a>
				</li>
			
				<li >
					<a href="../weve-officially-launched/">We’ve officially launched</a>
				</li>
			
				<li >
					<a href="../elmah-io-20140412-released/">elmah.io 20140412 released</a>
				</li>
			
				<li >
					<a href="../logging-to-elmah-io-from-serilog/">Logging to elmah.io from Serilog</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 March</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../elmah-io-20140315-released/">elmah.io 20140315 released</a>
				</li>
			
				<li >
					<a href="../logging-to-elmah-io-from-blogengine-net/">Logging to elmah.io from BlogEngine.NET</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 February</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../elmah-io-20140219-released/">elmah.io 20140219 released</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2014 Januar</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../logging-to-elmah-io-from-nancy/">Logging to elmah.io from Nancy</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2013 December</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../elmah-io-20131227-released/">elmah.io 20131227 released</a>
				</li>
			
				<li >
					<a href="../logging-to-elmah-io-from-servicestack/">Logging to elmah.io from ServiceStack</a>
				</li>
			
				<li class="active">
					<a href="./">Running ElasticSearch in a cluster on Azure</a>
				</li>
			
				<li >
					<a href="../elmah-io-20131212-released/">elmah.io 20131212 released. 2013</a>
				</li>
			
				<li >
					<a href="../using-multiple-elmah-io-logs-for-different-environments/">Using multiple elmah.io logs for different environments</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2013 November</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../logging-errors-to-elmah-io/">Logging errors to elmah.io</a>
				</li>
			
				<li >
					<a href="../elmah-io-20131111-released/">elmah.io 20131111 released</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2013 October</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../elmah-io-20131015-released/">elmah.io 20131015 released</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2013 September</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../elmah-io-20130922-released/">elmah.io 20130922 released</a>
				</li>
			
				<li >
					<a href="../logging-custom-errors-to-elmah-io/">Logging custom errors to elmah.io</a>
				</li>
			
				<li >
					<a href="../configuring-elmah-io-from-code/">Configuring elmah.io from code</a>
				</li>
			
				<li >
					<a href="../logging-to-elmah-io-from-web-api/">Logging to elmah.io from Web API</a>
				</li>
			
				<li >
					<a href="../elmah-io-20130908-released/">elmah.io 20130908 released</a>
				</li>
			
				<li >
					<a href="../elmah-elasticsearch-tutorial/">ELMAH Elasticsearch Tutorial</a>
				</li>
			
			</ul>
		
			<h4 href="#" >2013 August</h4>
			<ul class="nav bs-sidenav">
			
				<li >
					<a href="../elmah-tutorial/">ELMAH tutorial</a>
				</li>
			
			</ul>
		
		
	
		
	
</div></div>
            <div class="col-md-9" role="main" style="border-left: 1px solid #eee;">

<h1 id="running-elasticsearch-in-a-cluster-on-azure">Running ElasticSearch in a cluster on Azure</h1>
<h5 id="thomas-ardal-december-16-2013"><a href="http://elmah.io/about/">Thomas Ardal</a>, December 16, 2013</h5>
<h2 id="this-is-a-cross-post-from-thomasardalcom-about-how-weve-setup-elmahio-on-windows-azure">This is a cross post from <a href="http://thomasardal.com">thomasardal.com</a> about how we’ve setup elmah.io on Windows Azure.</h2>
<p>In this post I will share my experiences setting up ElasticSearch in a clustered setup of virtual machines, running on Windows Azure. Disclamer: this is in no way an official guide on how to setup ElasticSearch in a cluster. My experience with replication in ElasticSearch is pretty limited, and I only just now found out how virtual networks work in Windows Azure. Use this guide for inspiration and I would love to get some feedback on the approach used.</p>
<p>If you don’t have access to Azure, there’s a free trial available from the frontpage: http://www.windowsazure.com/en-us/pricing/free-trial/. You will get 30 days of Azure with a maximum of $200 worth of services. Pricing on Azure has always been a nightmare, but $200 should do just fine in order to play around with a couple of VMs. When signed up and in, start by creating a new virtual network:</p>
<p><img alt="Azure" src="../images/2013/12/azure_1.png" /></p>
<p>Input a name and create a new affinity group. For now we will just input values and discuss the details later:</p>
<p><img alt="Azure" src="../images/2013/12/azure_21.png" /></p>
<p>In the DNS Servers and VPN Connectivity step just click Next and Azure will control the DNS. The final step should look something like this:</p>
<p><img alt="Azure" src="../images/2013/12/azure_31.png" /></p>
<p>When finished click the Complete checkmark. So let’s rewind and talk about what we have done here. The virtual network is not necessary in order for ElasticSearch to work, but it makes it a hell of a lot easier, because all of the virtual machines on the same network will be able to communicate with each other, without you should worry about anything than allowing the connections through the firewall. More about that later.</p>
<p>I won’t go into details about the affinity group, but you can read a great introduction to affinity groups on Azure here: <a href="http://convective.wordpress.com/2012/06/10/affinity-groups-in-windows-azure/">http://convective.wordpress.com/2012/06/10/affinity-groups-in-windows-azure/</a>. Just think of the affinity group as a single container at Microsoft. Having all of your services in the same container, improves performance when communicating between different computers inside that container.</p>
<p>ElasticSearch requires some iron to execute. Let’s create a new virtual machine:</p>
<p><img alt="Azure" src="../images/2013/12/azure_4.png" /></p>
<p>We want a data center edition of Windows to run our cluster:</p>
<p><img alt="Azure" src="../images/2013/12/azure_5.png" /></p>
<p>Give you VM a name and pick a size of your choice:</p>
<p><img alt="Azure" src="../images/2013/12/azure_6.png" /></p>
<p>In the following step, we will use the new virtual network we just created. But before that, select the Create a new cloud service option from the Cloud Service select box. Cloud Services is a funny thing in Azure, because it maps to both a way of implementing web sites (web roles) and background jobs (worker roles) as well as to scale other services like virtual machines. In the Virtual Network select box, choose the elasticsearch-cluster network or whatever you decided to name it:</p>
<p><img alt="Azure" src="../images/2013/12/azure_7.png" /></p>
<p>Leave the endpoints as is and click the Complete check mark:</p>
<p><img alt="Azure" src="../images/2013/12/azure_8.png" /></p>
<p>A few minutes later, your virtual machine will be up and running. We could go on and install ElasticSearch now, but one machine doesn’t smell like a cluster, right? You guessed what next: more VMs! I’ve always considered two nodes running a piece of software in a cluster as safe, but my time at eBay taught me, that you’d always want three nodes in a cluster. It’s probably up for debate, but having only two nodes doesn’t really make it a cluster every time you need to take one out for patching or similar. That’s why we create two additional VMs. The steps are exactly the same as above, except the Cloud Service select box where you should choose the es-vms cloud service you’ve already created.</p>
<p>I’m assuming that you have three VM’s up and running:</p>
<p><img alt="Azure" src="../images/2013/12/azure_9.png" /></p>
<p>Now for the boring part: installing ElasticSearch. Actually it’s quite simple, but I wont go into detail on it, because it’s fairly well documented here in the <a href="../2013/09/ELMAH%20Elasticsearch%20Tutorial/">Installation part</a>. You might argue that we could do with installing ElasticSearch on a single VM and using that as a template for the other two VMs. You’re right! Azure supports creating new VMs from existing virtual discs, but I’ve never really tried, why I don’t want to write something rubbish. For now just install ElasticSearch on the three VMs.</p>
<p>Remember when I told the advantages about added all of the VMs to the same virtual network?  Well now it’s time to collect. ElasticSearch supports different types of discovery, which in plain words makes multiple ElasticSearch instances talk to each other. The default type of discovery is multicast where you do not need to configure anything. Unfortunately multicast doesn’t seem to work on Azure (yet), why we need to configure this using unicast. On each VM, open the elasticsearch.yml located in the config directory of ElasticSearch and search for <code>“# discovery.zen.ping.multicast.enabled: false”</code>. In order for ElasticSearch to use unicast, uncomment this line. Also you need to setup the IPs of the other ElasticSearch instances in our virtual network. In my case, the following line does the trick:</p>
<p><code>discovery.zen.ping.unicast.hosts: [“10.0.0.4”, “10.0.0.5”, “10.0.0.6”]</code></p>
<p>The IP addresses visible from the dashboard of each VM. Make sure that you pick the internal IPs. Finally you need to specify the same cluster name for all instances using this line:</p>
<p><code>cluster.name: elasticsearch</code></p>
<p>ElasticSearch communicates between nodes on port 9300 and accepts connections from the outside on port 9200, why you need to allow inbound access on these ports in Windows Firewall. Copy the elasticsearch.yml around and start ElasticSearch on all the VMs. Congratulations! You now have your first ElasticSearch cluster up and running.</p>
<p>To communicate with your new cluster from a Azure website or something outside Microsofts datacenters, you need access to port port 9200 on all of the VMs. If you inspect the public IPs if all three VMs you will notice, that it’s the same. All three ElasticSearch instances will be able to handle requests on this IP, but in order to do so, you need to configure load balancing on Azure. Load balancing in azure is implemented in a real simple way through Endpoints. Navigate to the endpoints tab of one of your VMs and create a new endpoint:</p>
<p><img alt="Azure" src="../images/2013/12/azure_10.png" /></p>
<p>In the following step input a name and port 9200 in both Public and Private Port. Make sure to check the Create a load balanced set:</p>
<p><img alt="Azure" src="../images/2013/12/azure_11.png" /></p>
<p>In the final step assign a name to the new load balanced endpoint and accept the default values in the rest of the fields:</p>
<p><img alt="Azure" src="../images/2013/12/azure_12.png" /></p>
<p>The only thing missing is creating the same endpoint on the remaining two virtual machines. Remember to select the existing load balanced set when creating the new endpoints. This makes Azure load balance incoming request to port 9200 on the IP of the VMs.</p>
<p>In my setup I’ve installed Head plugin for ElasticSearch, which makes it possible to visualize a new index on my cluster for you guys:</p>
<p><img alt="Azure" src="../images/2013/12/azure_13.png" /></p>


<br/><br/>
<h2>Comments</h2>
<hr/>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'elmahioblog';
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div>
		
		
			
        </div>

    <footer class="col-md-12">
        
    </footer>


        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>